name: "FreeCAD Integration (manual)"

on:
  workflow_dispatch:
    inputs:
      run_freecad_tests:
        description: "Run FreeCADCmd integration tests (downloads FreeCAD AppImage)"
        required: false
        default: "true"

jobs:
  freecad-integration:
    if: ${{ github.event.inputs.run_freecad_tests != 'false' }}
    runs-on: ubuntu-22.04  # Pinned because 'freecad' apt package is not available on Ubuntu 24.04 (ubuntu-latest)
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.x"
      - name: Install pytest
        run: python -m pip install --upgrade pip pytest
      - name: Install FreeCAD
        run: |
          sudo apt-get update
          sudo apt-get install -y freecad
      - name: Install FreeCAD pytest dependency
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pytest
      - name: Verify FreeCAD installation
        run: |
          echo "Checking freecad on PATH..."
          which freecad || echo "freecad not found on PATH"
          echo "Checking freecadcmd on PATH..."
          which freecadcmd || (echo "freecadcmd not found on PATH" && exit 1)
          echo "FreeCAD version:"
          freecadcmd --version || echo "Could not get FreeCAD version"
          echo "Ensuring pytest is available inside FreeCAD..."
          freecadcmd -c "import pytest; print('pytest import OK inside FreeCAD')"
      - name: Run FreeCAD integration tests
        run: freecadcmd -c "import run_freecad_tests"
