name: "FreeCAD Integration (manual)"

on:
  workflow_dispatch:
    inputs:
      run_freecad_tests:
        description: "Run FreeCADCmd integration tests (downloads FreeCAD AppImage)"
        required: false
        default: "true"

jobs:
  freecad-integration:
    if: ${{ github.event.inputs.run_freecad_tests != 'false' }}
    runs-on: ubuntu-22.04  # Pinned because 'freecad' apt package is not available on Ubuntu 24.04 (ubuntu-latest)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python (non-FreeCAD tooling)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install FreeCAD and test dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y freecad python3-pytest python3-pip

      - name: Install SquatchCut as a package (editable)
        working-directory: ${{ github.workspace }}
        run: |
          python3 -m pip install -e .

      - name: Verify FreeCAD + pytest + SquatchCut import
        working-directory: ${{ github.workspace }}
        env:
          PYTHONPATH: "${{ github.workspace }}"
        run: |
          echo "Checking freecad on PATH..."
          which freecad || echo "freecad not found on PATH"
          echo "Checking freecadcmd on PATH..."
          which freecadcmd || (echo "freecadcmd not found on PATH" && exit 1)
          echo "Python used by freecadcmd:"
          freecadcmd -c "import sys; print(sys.version)"
          echo "Checking pytest import under freecadcmd..."
          freecadcmd -c "import pytest; print('pytest import OK inside FreeCAD')"
          echo "Checking SquatchCut import under freecadcmd..."
          freecadcmd -c "import SquatchCut; print('SquatchCut imported from:', SquatchCut.__file__)"

      - name: Run FreeCAD integration tests
        working-directory: ${{ github.workspace }}
        env:
          PYTHONPATH: "${{ github.workspace }}"
        run: |
          freecadcmd -c "import run_freecad_tests"
